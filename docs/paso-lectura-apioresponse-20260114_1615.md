# Checklist paso `lectura-apioresponse` (2026-01-14 16:15)

- [ ] El paso se llama `lectura-apioresponse` y se ejecuta vía `step.do` en el workflow, deteniendo el flujo en caso de fallo ([workers/wf-procesar-factura/src/workflow.ts](workers/wf-procesar-factura/src/workflow.ts#L86-L123)).
- [ ] Las funciones de negocio residen en módulos TS separados e importados por el workflow: lectura y validación en [workers/wf-procesar-factura/src/lib/apioresponse.ts](workers/wf-procesar-factura/src/lib/apioresponse.ts#L85-L258); acceso R2 JSON en [workers/wf-procesar-factura/src/lib/storage.ts](workers/wf-procesar-factura/src/lib/storage.ts#L1-L12).
- [ ] El paso lee el JSON real en R2 `facturas/${invoiceId}/facturas-extraer-texto.json` y extrae solo `apioResponse.output` ([workers/wf-procesar-factura/src/lib/apioresponse.ts](workers/wf-procesar-factura/src/lib/apioresponse.ts#L85-L107)).
- [ ] Se valida que RO contenga únicamente `datos_generales` y `lineas`, con todos los campos obligatorios presentes y convertibles a tipo utilizable, normalizando mínimos tipos texto/número ([workers/wf-procesar-factura/src/lib/apioresponse.ts](workers/wf-procesar-factura/src/lib/apioresponse.ts#L109-L207)).
- [ ] En éxito, el paso devuelve solo el contexto mínimo (invoiceId, clave PDF, URL, nombre, contentType, ro) sin propagar `apioResponse` completo ni metadatos internos ([workers/wf-procesar-factura/src/workflow.ts](workers/wf-procesar-factura/src/workflow.ts#L86-L118)).
- [ ] En cualquier error de lectura/estructura/campos, se genera `error_validacion_factura.json` junto al PDF original usando el contrato fijado (tipo_error, descripcion, archivo, detalle_validacion, fecha_error) ([workers/wf-procesar-factura/src/workflow.ts](workers/wf-procesar-factura/src/workflow.ts#L119-L123); [workers/wf-procesar-factura/src/lib/apioresponse.ts](workers/wf-procesar-factura/src/lib/apioresponse.ts#L214-L247)).
- [ ] El flujo se detiene tras un fallo de validación; no hay pasos posteriores ejecutados ni persistencias adicionales (se lanza ValidationFailure) ([workers/wf-procesar-factura/src/workflow.ts](workers/wf-procesar-factura/src/workflow.ts#L86-L123)).
- [ ] Tests cubren casos válido e inválido (faltan campos) comprobando escritura de `error_validacion_factura.json` y detención del flujo ([workers/wf-procesar-factura/test/workflow.test.ts](workers/wf-procesar-factura/test/workflow.test.ts#L10-L138)).
- [ ] No se ha desplegado a Cloudflare; solo se modificó código y documentación local.
